pipeline {
    environment {
        registryCredential = 'jenkins_registry'
        project = 'sigpae-back'.toLowerCase()
        repo = 'https://github.com/prefeiturasp/SME-SIGPAE-API.git'
    }

    parameters {  
        string(name: 'branchname', defaultValue: 'homolog', description: 'Informe a branch que deseja executar o scan.')
    }
  
    agent { kubernetes { 
            label 'trivy'
            defaultContainer 'trivy'
        }
    }

    options {
        ansiColor('xterm')
        timestamps ()
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
        disableConcurrentBuilds()
    }
  
    stages {
        stage('Trivy Scan Repotorio') {
            steps {
                script {
                    echo "scan repositorio"
                    sh 'trivy repo ${repo} --output vulnerabilities.json --skip-version-check --format json --branch ${branchname}'
                    sh 'trivy scan2html generate --scan2html-flags --with-epss --output ${project}_repo_${branchname}.html --from vulnerabilities.json'
                }
            }
        }

        stage('Trivy Scan Imagem') {
            steps {
                script {
                    echo "scan imagem"
                    docker.withRegistry( 'https://registry.sme.prefeitura.sp.gov.br', registryCredential ) {
                        try {
                            sh "docker pull registry.sme.prefeitura.sp.gov.br/${branchname}/sme-sigpae-api:latest"
                            sh "trivy image registry.sme.prefeitura.sp.gov.br/${branchname}/sme-sigpae-api:latest --skip-version-check --output sme-sigpae-api.json --format json"
                            sh "trivy scan2html generate --scan2html-flags --with-epss --output sme-sigpae-api_image_${branchname}.html --from sme-sigpae-api.json"
                            sh "docker rmi registry.sme.prefeitura.sp.gov.br/${branchname}/sme-sigpae-api:latest"
                        } catch (e) {
                            echo "sme-sigpae-api - falhou"
                        }
                    }
                }
            }
        }
    }

    post {
        always {
            archiveArtifacts artifacts: '*.html', onlyIfSuccessful: true

            publishHTML([allowMissing: false, 
                alwaysLinkToLastBuild: true, 
                keepAll: false, 
                reportDir: '', 
                reportFiles: '*.html',
                reportName: 'Trivy Reports', 
                reportTitles: '', 
                useWrapperFileDirectly: true]
            )
        }
    }
}