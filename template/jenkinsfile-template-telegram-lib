@Library('shared-libs') _

pipeline {
    environment {
        branchname =  'master'
        TELEGRAM_CHAT_ID = 'telegramChatIdTest'
    }

    agent { kubernetes { 
            label 'builder-debian'
            defaultContainer 'builder-debian'
        }
    }

    options {
        ansiColor('xterm')
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '10'))
        disableConcurrentBuilds()
        timestamps ()
    }

    stages {
        stage('Tests') {
            steps {
                script {
                    env.failedStage = env.STAGE_NAME
                    echo "Testes"
                }
            }
        }

        stage('SonarQube') {
            steps {
                script {
                    env.failedStage = env.STAGE_NAME
                    
                    for (t in [
                        'TesteIntegracao',
                        'TesteUnitario'
                    ]) {
                        try {
                            unstash "coverage-${t}"
                        } catch (e) {
                            echo "Nenhum coverage encontrado para coverage ${t}"
                        }
                    }

                    sonarqubeDotnet(
                        scannerHome: "sonar-dotnet-10",
                        dotnetVersion: "dotnet-10",
                        coverageType: "dotnet-coverage",
                        project: "./src/SME.CDEP.Webapi/SME.CDEP.Webapi.csproj"
                    )
                }
            }
        }

        stage('Dockerfile Check') {
            steps {
                script {
                    env.failedStage = env.STAGE_NAME
                    dockerfileCheck(
                        dockerfilePath: "./Dockerfile",
                        imageName: "teste-imagem"
                    )
                }
            }
        }

        stage('build') {
            steps {
                script {
                    env.failedStage = env.STAGE_NAME
                    echo "Build"
                }
            }
        }

        stage('deploy') {
            steps {
                script {
                    env.failedStage = env.STAGE_NAME
                    approveTelegram(env.TELEGRAM_CHAT_ID)
                    def aprovadoPor = input(message: 'Deseja realizar o deploy?', ok: 'SIM', submitter: 'bruna_lima', submitterParameter: 'APPROVED_BY')
                    // def aprovadoPor = input(message: 'Deseja realizar o deploy?', ok: 'SIM', submitter: "${aprovadores}", submitterParameter: 'APPROVED_BY')
                    env.APROVADO_POR = "${aprovadoPor}"
                    approvedTelegram(env.TELEGRAM_CHAT_ID, env.APROVADO_POR)
                    echo "Deploy"
                }
            }
        }
    }

    post {
        success { sendTelegram("<b>SUCESSO! ✅</b>", env.TELEGRAM_CHAT_ID) }
        unstable { sendTelegram("<b>INSTÁVEL! ⚠️</b>", env.TELEGRAM_CHAT_ID) }
        failure { sendTelegram("<b>FALHA! ❌</b>\n<b>Stage com falha:</b> ${failedStage}", env.TELEGRAM_CHAT_ID) }
        aborted { sendTelegram("<b>CANCELADO! ✖️</b>\n", env.TELEGRAM_CHAT_ID) }
    }
}