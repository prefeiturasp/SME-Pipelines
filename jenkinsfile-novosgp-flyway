pipeline {
    environment {
        branchname =  env.BRANCH_NAME.toLowerCase()
    }
  
    agent { kubernetes { 
            label 'builder-debian'
            defaultContainer 'builder-debian'
        }
    }

    options {
        ansiColor('xterm')
        timestamps ()
        buildDiscarder(logRotator(numToKeepStr: '10', artifactNumToKeepStr: '5'))
        disableConcurrentBuilds()
    }
  
    stages {
        stage('Flyway') {
            agent { kubernetes { 
                    label 'flyway'
                    defaultContainer 'flyway'
                }
            }
            when { anyOf {  branch 'master'; branch 'homolog'; branch 'teste'; } }
            steps{
                withCredentials([string(credentialsId: "flyway_sgp_${branchname}", variable: 'url')]) {
                    checkout scm
                    sh 'flyway -url=$url -locations="filesystem:scripts" repair'
                    sh 'flyway -url=$url -locations="filesystem:scripts" -outOfOrder=true migrate'
                }
            }       
        }
    }
}